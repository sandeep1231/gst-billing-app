{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, inject } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { ApiService } from '../../services/api.service';\nexport let InvoiceListComponent = class InvoiceListComponent {\n  constructor() {\n    this.api = inject(ApiService);\n    this.invoices = [];\n    this.loading = false;\n    this.q = '';\n    this.from = '';\n    this.to = '';\n    this.page = 1;\n    this.limit = 20;\n    this.lastCount = 0;\n    this.summary = null;\n  }\n  ngOnInit() {\n    this.reload();\n  }\n  reload() {\n    this.loading = true;\n    const params = {\n      page: this.page,\n      limit: this.limit\n    };\n    if (this.q) params.q = this.q;\n    if (this.from) params.from = this.from;\n    if (this.to) params.to = this.to;\n    this.api.get('/invoices', params).subscribe({\n      next: data => {\n        this.invoices = data;\n        this.lastCount = data.length;\n        this.loading = false;\n      },\n      error: () => {\n        this.invoices = [];\n        this.loading = false;\n      }\n    });\n    // Load summary\n    const sParams = {};\n    if (this.q) sParams.q = this.q;\n    if (this.from) sParams.from = this.from;\n    if (this.to) sParams.to = this.to;\n    this.api.get('/reports/sales', sParams).subscribe({\n      next: s => this.summary = s,\n      error: () => this.summary = null\n    });\n  }\n  apply() {\n    this.page = 1;\n    this.reload();\n  }\n  prev() {\n    if (this.page > 1 && !this.loading) {\n      this.page--;\n      this.reload();\n    }\n  }\n  next() {\n    if (!this.loading && this.lastCount >= this.limit) {\n      this.page++;\n      this.reload();\n    }\n  }\n  exportCsv() {\n    const headers = ['Invoice No', 'Date', 'Customer', 'Sub Total', 'Tax', 'Total'];\n    const rows = this.invoices.map(inv => {\n      const tax = (inv.tax?.cgst || 0) + (inv.tax?.sgst || 0) + (inv.tax?.igst || 0);\n      const d = new Date(inv.date);\n      const ds = isNaN(d.getTime()) ? '' : d.toISOString().substring(0, 10);\n      return [inv.invoiceNo, ds, inv.customerSnapshot?.name || 'Walk-in', inv.subTotal, tax, inv.total];\n    });\n    const csv = [headers, ...rows].map(r => r.map(v => typeof v === 'string' ? '\"' + v.replace(/\"/g, '\"\"') + '\"' : v).join(',')).join('\\n');\n    const blob = new Blob([csv], {\n      type: 'text/csv;charset=utf-8;'\n    });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = 'invoices.csv';\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n    URL.revokeObjectURL(url);\n  }\n  exportAll() {\n    const params = {};\n    if (this.q) params.q = this.q;\n    if (this.from) params.from = this.from;\n    if (this.to) params.to = this.to;\n    this.api.getBlob('/invoices/export', params).subscribe({\n      next: blob => {\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = 'invoices_export.csv';\n        document.body.appendChild(a);\n        a.click();\n        a.remove();\n        URL.revokeObjectURL(url);\n      }\n    });\n  }\n  download(inv) {\n    this.api.getBlob(`/invoices/${inv._id}/pdf`).subscribe({\n      next: blob => {\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `${inv.invoiceNo || 'Invoice'}.pdf`;\n        document.body.appendChild(a);\n        a.click();\n        a.remove();\n        URL.revokeObjectURL(url);\n      }\n    });\n  }\n  markPaid(inv) {\n    const id = inv._id;\n    if (!id) return;\n    this.api.put(`/invoices/${id}/payment`, {\n      paidAmount: inv.total\n    }).subscribe({\n      next: () => this.reload()\n    });\n  }\n};\nInvoiceListComponent = __decorate([Component({\n  standalone: true,\n  selector: 'app-invoice-list',\n  imports: [CommonModule, FormsModule],\n  template: `\n  <div class=\"d-flex align-items-end gap-2 mb-2\">\n    <div class=\"me-auto\"><h5 class=\"m-0\">Recent Invoices</h5></div>\n  </div>\n  <form class=\"row g-2 mb-2\" (ngSubmit)=\"apply()\">\n    <div class=\"col-md-4\">\n      <input type=\"text\" class=\"form-control\" [(ngModel)]=\"q\" name=\"q\" placeholder=\"Search invoice no or customer\" />\n    </div>\n    <div class=\"col-md-3\">\n      <input type=\"date\" class=\"form-control\" [(ngModel)]=\"from\" name=\"from\" />\n    </div>\n    <div class=\"col-md-3\">\n      <input type=\"date\" class=\"form-control\" [(ngModel)]=\"to\" name=\"to\" />\n    </div>\n    <div class=\"col-md-2 d-grid\">\n      <div class=\"btn-group\">\n        <button class=\"btn btn-outline-secondary\" type=\"submit\">Apply</button>\n        <button class=\"btn btn-outline-primary\" type=\"button\" (click)=\"exportCsv()\" [disabled]=\"loading || invoices.length===0\">CSV</button>\n        <button class=\"btn btn-outline-success\" type=\"button\" (click)=\"exportAll()\" [disabled]=\"loading\">Export All</button>\n      </div>\n    </div>\n  </form>\n  <div class=\"table-responsive\">\n    <table class=\"table table-sm align-middle\">\n      <thead>\n        <tr>\n          <th style=\"width:22%\">Invoice No</th>\n          <th style=\"width:18%\">Date</th>\n          <th>Customer</th>\n          <th class=\"text-end\" style=\"width:12%\">Due (₹)</th>\n          <th class=\"text-end\" style=\"width:15%\">Total (₹)</th>\n          <th class=\"text-end\" style=\"width:15%\">Tax (₹)</th>\n          <th style=\"width:15%\" class=\"text-end\">Actions</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr *ngFor=\"let inv of invoices\">\n          <td>{{ inv.invoiceNo }}</td>\n          <td>{{ inv.date | date:'mediumDate' }}</td>\n          <td>{{ inv.customerSnapshot?.name || 'Walk-in' }}</td>\n          <td class=\"text-end\">{{ (inv.total - (inv as any).paidAmount || 0) | number:'1.2-2' }}</td>\n          <td class=\"text-end\">{{ inv.total | number:'1.2-2' }}</td>\n          <td class=\"text-end\">{{ (inv.tax?.cgst || 0) + (inv.tax?.sgst || 0) + (inv.tax?.igst || 0) | number:'1.2-2' }}</td>\n          <td class=\"text-end\">\n            <div class=\"btn-group btn-group-sm\">\n              <button class=\"btn btn-outline-primary\" (click)=\"download(inv)\">PDF</button>\n              <button class=\"btn btn-outline-success\" (click)=\"markPaid(inv)\" [disabled]=\"(inv as any).paidAmount >= inv.total\">Mark Paid</button>\n            </div>\n          </td>\n        </tr>\n        <tr *ngIf=\"!loading && invoices.length === 0\">\n          <td colspan=\"6\" class=\"text-center text-muted\">No invoices yet.</td>\n        </tr>\n      </tbody>\n      <tfoot *ngIf=\"summary\">\n        <tr class=\"table-light\">\n          <th colspan=\"3\" class=\"text-end\">Summary (filtered)</th>\n          <th class=\"text-end\">₹{{ summary.total | number:'1.2-2' }}</th>\n          <th class=\"text-end\">₹{{ (summary.cgst + summary.sgst + summary.igst) | number:'1.2-2' }}</th>\n          <th></th>\n        </tr>\n      </tfoot>\n    </table>\n  </div>\n  <div class=\"d-flex align-items-center gap-2 mt-2\">\n    <div class=\"me-auto text-muted\">Page {{ page }}</div>\n    <div class=\"btn-group\">\n      <button class=\"btn btn-sm btn-outline-secondary\" (click)=\"prev()\" [disabled]=\"loading || page <= 1\">Prev</button>\n      <button class=\"btn btn-sm btn-outline-secondary\" (click)=\"next()\" [disabled]=\"loading || lastCount < limit\">Next</button>\n    </div>\n  </div>\n  `\n})], InvoiceListComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}