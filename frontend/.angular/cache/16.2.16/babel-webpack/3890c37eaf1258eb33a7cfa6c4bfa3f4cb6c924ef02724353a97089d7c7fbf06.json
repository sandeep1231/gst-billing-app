{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule, NgFor, NgIf } from '@angular/common';\nimport { ReactiveFormsModule, Validators } from '@angular/forms';\nimport { NgbTypeaheadModule } from '@ng-bootstrap/ng-bootstrap';\nimport { of } from 'rxjs';\nimport { debounceTime, distinctUntilChanged, switchMap, catchError } from 'rxjs/operators';\nexport let PurchasesPage = class PurchasesPage {\n  constructor(fb, products, purchases) {\n    this.fb = fb;\n    this.products = products;\n    this.purchases = purchases;\n    this.rows = [];\n    this.loading = false;\n    this.form = this.fb.group({\n      vendorName: [''],\n      items: this.fb.array([])\n    });\n    this.productFormatter = p => typeof p === 'string' ? p : `${p.name} (₹${p.price})`;\n    this.productSearch = text$ => text$.pipe(debounceTime(200), distinctUntilChanged(), switchMap(term => term && term.length >= 2 ? this.products.search(term) : of([])), catchError(() => of([])));\n  }\n  get items() {\n    return this.form.get('items');\n  }\n  addItem() {\n    const g = this.fb.group({\n      product: this.fb.control(null),\n      productId: [''],\n      name: ['', Validators.required],\n      qty: [1, Validators.required],\n      price: [0, Validators.required],\n      gstPercent: [0]\n    });\n    this.items.push(g);\n  }\n  onProductSelected(i, p) {\n    if (p && typeof p !== 'string') {\n      const g = this.items.at(i);\n      g.patchValue({\n        productId: p._id || '',\n        name: p.name,\n        price: p.price,\n        gstPercent: p.gstPercent\n      });\n    }\n  }\n  ngOnInit() {\n    this.reload();\n    if (this.items.length === 0) this.addItem();\n  }\n  reload() {\n    this.loading = true;\n    this.purchases.list().subscribe({\n      next: data => {\n        this.rows = data;\n        this.loading = false;\n      },\n      error: () => {\n        this.rows = [];\n        this.loading = false;\n      }\n    });\n  }\n  submit() {\n    if (this.form.invalid || this.items.length === 0) return;\n    const payload = {\n      vendorName: this.form.value.vendorName || '',\n      items: this.items.controls.map(c => {\n        const it = c.value;\n        return {\n          productId: it.productId || undefined,\n          name: it.name,\n          qty: Number(it.qty),\n          price: Number(it.price),\n          gstPercent: Number(it.gstPercent || 0)\n        };\n      })\n    };\n    this.loading = true;\n    this.purchases.create(payload).subscribe({\n      next: () => {\n        this.loading = false;\n        this.reset();\n        this.reload();\n        alert('Purchase saved');\n      },\n      error: () => {\n        this.loading = false;\n        alert('Failed to save');\n      }\n    });\n  }\n  reset() {\n    this.form.reset({\n      vendorName: ''\n    });\n    this.items.clear();\n    this.addItem();\n  }\n  markPaid(p) {\n    if (!p?._id) return;\n    this.purchases.pay(p._id, p.total).subscribe({\n      next: () => this.reload()\n    });\n  }\n};\nPurchasesPage = __decorate([Component({\n  standalone: true,\n  imports: [CommonModule, ReactiveFormsModule, NgIf, NgFor, NgbTypeaheadModule],\n  template: `\n  <div class=\"row g-3\">\n    <div class=\"col-lg-6 order-2 order-lg-1\">\n      <h5>Recent Purchases</h5>\n      <div class=\"table-responsive\">\n        <table class=\"table table-sm align-middle\">\n          <thead>\n            <tr>\n              <th>Date</th>\n              <th>Vendor</th>\n              <th class=\"text-end\">Due (₹)</th>\n              <th class=\"text-end\">Total (₹)</th>\n              <th class=\"text-end\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr *ngFor=\"let p of rows\">\n              <td>{{ p.date | date:'mediumDate' }}</td>\n              <td>{{ p.vendorName || '-' }}</td>\n              <td class=\"text-end\">{{ (p.total - (p as any).paidAmount || 0) | number:'1.2-2' }}</td>\n              <td class=\"text-end\">{{ p.total | number:'1.2-2' }}</td>\n              <td class=\"text-end\">\n                <button class=\"btn btn-sm btn-outline-success\" (click)=\"markPaid(p)\" [disabled]=\"(p as any).paidAmount >= p.total\">Mark Paid</button>\n              </td>\n            </tr>\n            <tr *ngIf=\"!loading && rows.length === 0\">\n              <td colspan=\"3\" class=\"text-center text-muted\">No purchases yet.</td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n    <div class=\"col-lg-6 order-1 order-lg-2\">\n      <div class=\"card\">\n        <div class=\"card-body\">\n          <h5 class=\"card-title\">New Purchase</h5>\n          <form [formGroup]=\"form\" (ngSubmit)=\"submit()\" class=\"row g-2\">\n            <div class=\"col-12\">\n              <label class=\"form-label\">Vendor</label>\n              <input type=\"text\" class=\"form-control\" formControlName=\"vendorName\" />\n            </div>\n            <div class=\"col-12\">\n              <label class=\"form-label\">Items</label>\n              <table class=\"table table-sm align-middle\">\n                <thead>\n                  <tr>\n                    <th style=\"width:38%\">Product</th>\n                    <th style=\"width:16%\">Qty</th>\n                    <th style=\"width:23%\">Price</th>\n                    <th style=\"width:23%\">GST %</th>\n                  </tr>\n                </thead>\n                <tbody formArrayName=\"items\">\n                  <tr *ngFor=\"let it of items.controls; let i = index\" [formGroupName]=\"i\">\n                    <td>\n                      <input type=\"text\" class=\"form-control\" formControlName=\"name\"\n                        [ngbTypeahead]=\"productSearch\" [resultFormatter]=\"productFormatter\" [inputFormatter]=\"productFormatter\"\n                        (selectItem)=\"onProductSelected(i, $event.item)\" placeholder=\"Search product\" />\n                    </td>\n                    <td><input type=\"number\" class=\"form-control\" formControlName=\"qty\" min=\"1\" /></td>\n                    <td><input type=\"number\" class=\"form-control\" formControlName=\"price\" step=\"0.01\" /></td>\n                    <td><input type=\"number\" class=\"form-control\" formControlName=\"gstPercent\" step=\"0.1\" /></td>\n                  </tr>\n                </tbody>\n              </table>\n              <button type=\"button\" class=\"btn btn-outline-primary btn-sm\" (click)=\"addItem()\">Add Item</button>\n            </div>\n            <div class=\"col-12 d-flex gap-2\">\n              <button class=\"btn btn-primary\" type=\"submit\" [disabled]=\"form.invalid || items.length === 0 || loading\">Save Purchase</button>\n              <button class=\"btn btn-outline-secondary\" type=\"button\" (click)=\"reset()\">Reset</button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  </div>\n  `\n})], PurchasesPage);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}